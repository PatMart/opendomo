#!/bin/sh
#desc: Make opendomo squash filesystems

# USAGE:
#   mkrootfs              Save config
#   mkrootfs    reboot    Save config anr reboot system
#   mkrootfs    restore   Restore default config

# Variables
IMAGESDIR="/mnt/system/images"
DEFIMAGE="$IMAGESDIR/dfchange.img"
CSTIMAGE="$IMAGESDIR/ctchange.img"
MOUNTDIR="/run/mounts/changerw"
CHANGEDIR="/run/mounts/change"
TEMPFSDIR="/run/mounts/tmpfs"

SYSSTATE="/var/opendomo/run/Systembusy.pid"
SYNCOPTS="--quiet --archive --exclude-from=/etc/mkrootfs.excludes"
FINDCMD=`find $TEMPFSDIR -name ".wh.*" -not -name ".wh..*" | sed 's/tmpfs/changerw/'`

if ! test -d $IMAGESDIR; then
    echo "#ERRO System device is not mounted, the configuration can't be saved"
    echo
    exit 1

elif [ "$1" = "restore" ]; then
    # Entering in busy system state
    echo "Restoring system" > $SYSSTATE

    # Delete changes image and restore default config
    echo "#LOADING Restoring default system ..."
    echo

    rm -f $CSTIMAGE 2>/dev/null
    gunzip $DEFIMAGE.gz
    cp $DEFIMAGE $CSTIMAGE

    # Deleting busy system state
    rm $SYSSTATE

else
    # Entering in busy system state
    echo "Saving configuration" > $SYSSTATE

    # Save changes in custom image, first mount custom image in rw
    mkdir -p $MOUNTDIR
    mount $CSTIMAGE $MOUNTDIR || exit 1

    # Copy new files in image
    echo "#LOADING Save system configuration (please wait) ..."
    echo
    rsync $SYNCOPTS $TEMPFSDIR/ $MOUNTDIR/

    # Delete missing files in image
    for file in $FINDCMD; do
        FILENAME=`basename $file | sed 's/.sh.//'`
        DIRNAME=`dirname $file`
        if test -f $DIRNAME/$FILENAME; then
            echo "#INF Delete $FILENAME"
            rm -r $DIRNAME/$FILENAME
        fi
    done

    # Unmount image
    while ! umount $MOUNTDIR; do
        sleep 1
    done
    rmdir $MOUNTDIR 2>/dev/null

    # Deleting busy mode
    rm $SYSSTATE
fi

# Check reboot system warrant
if [ "$1" == "reboot" ]; then
    echo "#> Configuration saved"
    echo "#INFO Your configuration was saved, rebooting system ..."
    echo
    shutdown -r now
else
    echo "#> Configuration saved"
    echo "#INFO Your configuration was saved"
    echo
fi
